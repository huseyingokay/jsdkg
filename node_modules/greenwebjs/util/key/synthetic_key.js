"use strict";
// https://github.com/Chia-Network/chia-blockchain/blob/5f4e39480e2312dc93a7b3609bcea576a9a758f9/chia/wallet/puzzles/p2_delegated_puzzle_or_hidden_puzzle.py#L70
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SyntheticKeyUtil = void 0;
const bignumber_1 = require("@ethersproject/bignumber");
const crypto_js_1 = __importDefault(require("crypto-js"));
const __1 = require("..");
class SyntheticKeyUtil {
    static intToBytes(b) {
        return bignumber_1.BigNumber.from("0x" + b).fromTwos(256);
    }
    static calculateSyntheticOffset(publicKey, hiddenPuzzleHash) {
        const toHash = __1.Util.key.publicKeyToHex(publicKey) + hiddenPuzzleHash;
        const hash = crypto_js_1.default.enc.Hex.stringify(crypto_js_1.default.SHA256(crypto_js_1.default.enc.Hex.parse(toHash)));
        const blob = this.intToBytes(hash);
        return blob.mod(this.GROUP_ORDER);
    }
    static calculateSyntheticSecretKey(secretKey, hiddenPuzzleHash = __1.Util.sexp.DEFAULT_HIDDEN_PUZZLE_HASH) {
        const privKeyNum = bignumber_1.BigNumber.from("0x" + __1.Util.key.privateKeyToHex(secretKey));
        const pubKey = secretKey.get_g1();
        const syntheticOffset = this.calculateSyntheticOffset(pubKey, hiddenPuzzleHash);
        const syntheticSecretExponent = privKeyNum.add(syntheticOffset).mod(this.GROUP_ORDER);
        let blob = syntheticSecretExponent.toHexString().slice(2);
        if (blob.length < 64) {
            blob = "0".repeat(64 - blob.length) + blob;
        }
        return __1.Util.key.hexToPrivateKey(blob);
    }
}
exports.SyntheticKeyUtil = SyntheticKeyUtil;
SyntheticKeyUtil.GROUP_ORDER = bignumber_1.BigNumber.from("0x73EDA753299D7D483339D80809A1D80553BDA402FFFE5BFEFFFFFFFF00000001");
//# sourceMappingURL=synthetic_key.js.map